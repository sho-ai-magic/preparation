<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ã•ã®ã˜ã‚…ã‚“ã³ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }

        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            border-width: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .dragging {
            opacity: 0.5;
            scale: 0.95;
            z-index: 50;
        }

        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-out forwards;
        }

        @keyframes pulse-orange {
            0%, 100% { background-color: #f97316; }
            50% { background-color: #ea580c; }
        }
        .animate-pulse-orange {
            animation: pulse-orange 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shine {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.1); filter: brightness(1.3); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .earned-stamp {
            animation: shine 2s infinite;
        }
    </style>
</head>
<body class="bg-blue-50 h-[100dvh] w-screen p-4 lg:p-6">

    <div class="flex flex-col lg:flex-row h-full gap-4 lg:gap-6">
        
        <!-- å³å´ãƒ»ä¸Šéƒ¨: æ™‚è¨ˆãƒ»ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ -->
        <div class="w-full lg:w-1/3 flex flex-row lg:flex-col gap-3 lg:gap-6 shrink-0 order-1 lg:order-2 min-h-0">
            <!-- ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚è¨ˆ -->
            <div class="flex-1 lg:flex-none bg-gradient-to-br from-yellow-300 to-yellow-400 rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-6 flex flex-col items-center justify-center text-white border-b-4 lg:border-b-8 border-yellow-500/30">
                <div id="digital-clock" class="text-4xl lg:text-6xl font-black drop-shadow-lg tracking-tight leading-none">00:00</div>
                <div id="digital-seconds" class="text-lg lg:text-xl font-bold opacity-90">00</div>
            </div>

            <!-- å‡ºç™ºã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ / è¨­å®š -->
            <div id="countdown-card" class="flex-[1.5] lg:flex-1 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-3 lg:p-6 flex flex-col items-center justify-center border-t-8 lg:border-t-[12px] border-orange-400 relative overflow-hidden min-w-0">
                
                <div id="normal-view" class="w-full flex flex-col items-center">
                    <div class="text-orange-500 font-black text-xs lg:text-lg mb-1 lg:mb-2 flex items-center gap-2">
                        <span>ã—ã‚…ã£ã±ã¤ã¾ã§</span>
                    </div>
                    <div id="countdown-timer" class="text-lg md:text-xl lg:text-2xl font-black text-gray-700 text-center leading-tight mb-2 lg:mb-4 flex flex-wrap justify-center items-center gap-1">
                        ã‚ã¨ -- æ™‚é–“ -- åˆ† -- ç§’
                    </div>
                    
                    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
                    <div class="w-full border-t border-gray-100 pt-3 lg:pt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] lg:text-xs font-black text-gray-400">ã—ã‚…ã†ã‹ã‚“ã‚¹ã‚¿ãƒ³ãƒ—</span>
                            <div class="flex items-center gap-1 text-yellow-500 font-black text-xs">
                                ğŸ† <span id="perfect-count">0</span>
                            </div>
                        </div>
                        <div id="stamp-row" class="flex justify-between gap-1">
                            <!-- JSã§ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="w-full mt-3">
                        <input type="time" id="departure-input" value="08:00" onchange="updateDepartureTime()" class="w-full max-w-[140px] lg:max-w-[160px] mx-auto block p-1 lg:p-2 bg-gray-50 border-2 border-gray-100 rounded-xl text-lg lg:text-2xl font-black text-center text-blue-600 focus:border-blue-400 outline-none">
                    </div>
                </div>

                <div id="settings-view" class="w-full hidden h-full overflow-y-auto pr-1">
                    <h3 class="text-center font-black text-orange-500 mb-2 text-sm lg:text-base">âš™ï¸ ã›ã£ã¦ã„</h3>
                    <div class="mb-4 flex flex-col gap-1 items-center">
                        <button onclick="testSound()" class="bg-gray-800 text-white text-[10px] px-3 py-1 rounded-full font-bold">éŸ³ã‚’ãªã‚‰ã—ã¦ã¿ã‚‹</button>
                    </div>
                    <div class="text-[10px] font-bold text-gray-400 mb-1 uppercase">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚ã¤ã‚ã‚‹æ›œæ—¥</div>
                    <div id="day-toggle-list" class="grid grid-cols-4 gap-1 mb-4">
                        <!-- JS -->
                    </div>
                    <div class="text-[10px] font-bold text-gray-400 mb-1 uppercase">ã‚¢ãƒ©ãƒ¼ãƒ </div>
                    <div id="alarm-list" class="space-y-1">
                        <!-- JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å·¦å´ãƒ»ä¸‹éƒ¨: ã‚¿ã‚¹ã‚¯ç®¡ç† -->
        <div class="flex-[2] min-h-0 w-full lg:w-2/3 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col order-2 lg:order-1 border-b-8 border-blue-200">
            <div class="flex justify-between items-center lg:items-end mb-3 lg:mb-6 shrink-0">
                <div>
                    <h1 class="text-xl lg:text-4xl font-black text-blue-600 lg:mb-2 leading-none">ã‚ã•ã®ã˜ã‚…ã‚“ã³</h1>
                    <div class="flex items-center gap-2 lg:gap-4 mt-1">
                        <div class="w-24 lg:w-64 h-3 lg:h-6 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-50">
                            <div id="progress-bar" class="h-full bg-green-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="font-bold text-xs lg:text-xl text-gray-500">0 / 0</span>
                    </div>
                </div>
                <button onclick="toggleSettings()" id="settings-btn" class="p-2 lg:p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>

            <div id="task-grid" class="flex-1 min-h-0 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-2 lg:gap-6 pb-2 overflow-hidden">
                <!-- JavaScript -->
            </div>

            <div class="mt-2 lg:mt-4 flex flex-col lg:flex-row justify-between items-center gap-2 shrink-0">
                <div id="add-task-form" class="flex gap-2 items-center w-full lg:w-auto">
                    <input type="text" id="new-task-input" placeholder="ã‚¿ã‚¹ã‚¯ã‚’ã¤ã„ã‹" class="flex-1 lg:w-48 px-3 py-1 lg:px-4 lg:py-2 border-2 border-gray-200 rounded-xl outline-none font-bold text-xs lg:text-base">
                    <button onclick="addTask()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <button onclick="resetAll()" class="flex items-center gap-2 text-gray-400 hover:text-gray-600 font-bold text-[10px] lg:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    ã‚„ã‚ŠãªãŠã™
                </button>
            </div>
        </div>
    </div>

    <!-- ãŠç¥ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="celebration-overlay" class="fixed inset-0 z-[100] bg-[#fff0f3]/95 hidden flex flex-col items-center justify-center text-rose-600 p-6 text-center overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div class="relative z-10 flex flex-col items-center">
            <div id="celebration-title-box" class="bg-white rounded-3xl p-6 lg:p-10 shadow-2xl mb-6">
                <h2 id="main-celebration-title" class="text-4xl lg:text-7xl font-black mb-4">ã˜ã‚…ã‚“ã³ ã‹ã‚“ã‚Šã‚‡ã†ï¼</h2>
                <p id="main-celebration-desc" class="text-lg lg:text-2xl font-bold opacity-90">ã™ã”ã„ï¼ãœã‚“ã¶ ã§ããŸã­ï¼</p>
            </div>
            <button onclick="closeCelebration()" class="bg-rose-500 text-white px-16 py-4 rounded-full text-2xl lg:text-4xl font-black shadow-2xl transition-transform active:scale-95">
                ã¯ãƒ¼ã„ï¼
            </button>
        </div>
    </div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="alarm-overlay" class="fixed inset-0 z-[110] animate-pulse-orange hidden flex flex-col items-center justify-center text-white p-10 text-center">
        <div class="bg-white/20 rounded-full p-10 mb-8"><svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
        <h2 id="alarm-title" class="text-4xl lg:text-7xl font-black mb-4">ã‚ã¨ 10ãµã‚“ï¼</h2>
        <button onclick="closeAlarm()" class="bg-white text-orange-600 px-16 py-6 rounded-full text-3xl lg:text-5xl font-black shadow-2xl active:scale-95">ã‚ã‹ã£ãŸï¼</button>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full font-bold shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4 z-50"></div>

    <script>
        const DEFAULT_TASKS = [
            { id: 1, text: 'ã¯ã¿ãŒã', completed: false },
            { id: 2, text: 'ã‚ã•ã”ã¯ã‚“', completed: false },
            { id: 3, text: 'ãƒˆã‚¤ãƒ¬', completed: false },
            { id: 4, text: 'ããŒãˆ', completed: false },
            { id: 5, text: 'ãã¤ã—ãŸ', completed: false },
            { id: 6, text: 'ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«', completed: false },
            { id: 7, text: 'ã‹ã¿ã®ã‘', completed: false }
        ];

        const DAY_LABELS = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

        let tasks = [];
        let departureTime = "08:00";
        let isSettingsMode = false;
        let lastDateString = new Date().toDateString(); 
        let alarmConfig = { 30: true, 20: true, 10: true, 5: true, 0: true };
        let lastAlarmTriggered = ""; 
        let draggedItemIndex = null;
        let celebrationShownToday = false; 

        // ã‚¹ã‚¿ãƒ³ãƒ—é–¢é€£ãƒ‡ãƒ¼ã‚¿
        let enabledDays = [false, true, true, true, true, true, false]; // æ—¥,æœˆ,ç«,æ°´,æœ¨,é‡‘,åœŸ
        let stamps = [false, false, false, false, false, false, false];
        let perfectWeekCount = 0;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        window.onload = () => {
            loadFromStorage();
            renderTasks();
            renderAlarmSettings();
            renderDayToggles();
            renderStamps();
            startClock();
            
            document.getElementById('new-task-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            window.addEventListener('resize', renderTasks);
        };

        function saveToStorage() {
            const data = {
                tasks,
                departureTime,
                saveDate: new Date().toDateString(),
                alarmConfig,
                celebrationShownToday,
                enabledDays,
                stamps,
                perfectWeekCount
            };
            localStorage.setItem('morning_routine_v2_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('morning_routine_v2_data');
            const today = new Date().toDateString();

            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.saveDate !== today) {
                        tasks = (parsed.tasks || DEFAULT_TASKS).map(t => ({ ...t, completed: false }));
                        celebrationShownToday = false;
                    } else {
                        tasks = parsed.tasks || DEFAULT_TASKS;
                        celebrationShownToday = parsed.celebrationShownToday || false;
                    }
                    departureTime = parsed.departureTime || "08:00";
                    alarmConfig = parsed.alarmConfig || alarmConfig;
                    enabledDays = parsed.enabledDays || enabledDays;
                    stamps = parsed.stamps || stamps;
                    perfectWeekCount = parsed.perfectWeekCount || 0;
                    
                    document.getElementById('departure-input').value = departureTime;
                    document.getElementById('perfect-count').textContent = perfectWeekCount;
                } catch (e) { tasks = DEFAULT_TASKS; }
            } else { tasks = DEFAULT_TASKS; }
        }

        function playBeep(freq = 880, duration = 0.1, delay = 0) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + delay + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration);
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const uttr = new SpeechSynthesisUtterance(text);
                uttr.lang = 'ja-JP';
                window.speechSynthesis.speak(uttr);
            }
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const nowDateString = now.toDateString();
                
                // æ—¥ä»˜å¤‰æ›´ãƒã‚§ãƒƒã‚¯
                if (nowDateString !== lastDateString) {
                    // æœˆæ›œæ—¥ã®ãƒªã‚»ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
                    if (now.getDay() === 1) { // 1 = Monday
                        stamps = stamps.map(() => false);
                        showToast("æ–°ã—ã„ä¸€é€±é–“ãŒã¯ã˜ã¾ã£ãŸã‚ˆï¼ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸã‚ˆã€‚");
                    }
                    lastDateString = nowDateString;
                    celebrationShownToday = false;
                    resetAll();
                }

                document.getElementById('digital-clock').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                document.getElementById('digital-seconds').textContent = String(now.getSeconds()).padStart(2, '0');
                
                updateCountdown(now);
                checkAlarms(now);
            }, 1000);
        }

        function checkAlarms(now) {
            const [depH, depM] = departureTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(depH, depM, 0, 0);
            if (target < now) target.setDate(target.getDate() + 1);

            const diffMins = Math.floor((target - now) / 60000);
            const isAllDone = tasks.length > 0 && tasks.every(t => t.completed);

            [30, 20, 10, 5, 0].forEach(point => {
                if (diffMins === point && alarmConfig[point]) {
                    const triggerId = `${now.getHours()}:${now.getMinutes()}:${point}`;
                    if (lastAlarmTriggered === triggerId) return;
                    if ([30, 20, 10].includes(point) && isAllDone) return;
                    lastAlarmTriggered = triggerId;
                    showAlarm(point);
                }
            });
        }

        function showAlarm(point) {
            const overlay = document.getElementById('alarm-overlay');
            const title = document.getElementById('alarm-title');
            for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2);

            if (point === 0) {
                title.textContent = "ã—ã‚…ã£ã±ã¤ï¼";
                speakText("å‡ºç™ºã®æ™‚é–“ã ã‚ˆï¼å¿˜ã‚Œç‰©ã¯ãªã„ã‹ãªï¼Ÿ");
            } else {
                title.textContent = `ã‚ã¨ ${point}ãµã‚“ï¼`;
                speakText(`å‡ºç™ºã¾ã§ã‚ã¨${point}åˆ†ã ã‚ˆã€‚æº–å‚™ã‚’ã™ã™ã‚ã‚ˆã†ï¼`);
            }
            overlay.classList.remove('hidden');
        }

        function closeAlarm() { document.getElementById('alarm-overlay').classList.add('hidden'); window.speechSynthesis.cancel(); }
        function testSound() { audioCtx.resume(); for(let i=0; i<3; i++) playBeep(880, 0.1, i * 0.2); speakText("ãƒ†ã‚¹ãƒˆã ã‚ˆï¼"); }

        function updateCountdown(now) {
            const [depH, depM] = departureTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(depH, depM, 0, 0);
            if (target < now) target.setDate(target.getDate() + 1);

            const diff = target - now;
            const timerElement = document.getElementById('countdown-timer');
            
            if (diff <= 0) {
                timerElement.innerHTML = `<span class="text-red-500 animate-bounce">ã—ã‚…ã£ã±ã¤ã®ã˜ã‹ã‚“ã ã‚ˆï¼</span>`;
            } else {
                const totalSecs = Math.floor(diff / 1000);
                const h = Math.floor(totalSecs / 3600);
                const m = Math.floor((totalSecs % 3600) / 60);
                const s = totalSecs % 60;
                let html = '<span class="text-xs mr-1 opacity-50">ã‚ã¨</span>';
                if (h > 0) html += `<span>${h}</span><span class="text-[0.5em] mx-0.5">æ™‚é–“</span>`;
                html += `<span>${m}</span><span class="text-[0.5em] mx-0.5">åˆ†</span><span>${s}</span><span class="text-[0.5em] mx-0.5">ç§’</span>`;
                timerElement.innerHTML = html;
            }
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid');
            grid.innerHTML = '';
            const cols = window.innerWidth >= 640 ? 3 : 2;
            const rows = Math.ceil(tasks.length / cols);
            grid.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;

            tasks.forEach((task, index) => {
                const card = document.createElement('div');
                card.className = 'card-container';
                card.setAttribute('data-index', index);
                card.addEventListener('touchstart', (e) => { draggedItemIndex = index; e.currentTarget.classList.add('dragging'); }, {passive: true});
                card.addEventListener('touchend', (e) => {
                    e.currentTarget.classList.remove('dragging');
                    const touch = e.changedTouches[0];
                    const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
                    const targetCard = targetEl?.closest('.card-container');
                    if (targetCard && draggedItemIndex !== null) {
                        const targetIndex = parseInt(targetCard.getAttribute('data-index'));
                        if (draggedItemIndex !== targetIndex) {
                            const item = tasks.splice(draggedItemIndex, 1)[0];
                            tasks.splice(targetIndex, 0, item);
                            saveToStorage(); renderTasks();
                        }
                    }
                    draggedItemIndex = null;
                });

                card.innerHTML = `
                    <div class="card-inner ${task.completed ? 'is-flipped' : ''}" onclick="toggleTask(${task.id})">
                        <div class="card-front bg-white border-blue-200 text-blue-700">
                            <span class="text-xs lg:text-xl font-black px-1 text-center pointer-events-none">${task.text}</span>
                            ${isSettingsMode ? `<button onclick="event.stopPropagation(); deleteTask(${task.id})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>` : ''}
                        </div>
                        <div class="card-back bg-green-100 border-green-400 text-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="text-green-500 mb-1"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span class="text-[10px] lg:text-base font-black">ã§ããŸï¼</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            updateProgress();
        }

        function renderStamps() {
            const container = document.getElementById('stamp-row');
            container.innerHTML = '';
            // æœˆæ›œ(1)ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ã‚ˆã†ã«ä¸¦ã³æ›¿ãˆã¦è¡¨ç¤º
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                if (!enabledDays[d]) return;
                const earned = stamps[d];
                const div = document.createElement('div');
                div.className = `flex-1 flex flex-col items-center p-1 rounded-lg border ${earned ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-100'}`;
                div.innerHTML = `
                    <span class="text-[8px] font-bold ${earned ? 'text-yellow-600' : 'text-gray-400'}">${DAY_LABELS[d]}</span>
                    <span class="text-lg ${earned ? 'earned-stamp' : 'opacity-20 grayscale'}">${earned ? 'ğŸŒŸ' : 'â—¯'}</span>
                `;
                container.appendChild(div);
            });
        }

        function renderDayToggles() {
            const container = document.getElementById('day-toggle-list');
            container.innerHTML = '';
            [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                const active = enabledDays[d];
                const btn = document.createElement('button');
                btn.className = `p-1 rounded text-[10px] font-bold border ${active ? 'bg-blue-500 text-white border-blue-600' : 'bg-gray-100 text-gray-400 border-gray-200'}`;
                btn.textContent = DAY_LABELS[d];
                btn.onclick = () => { enabledDays[d] = !enabledDays[d]; renderDayToggles(); renderStamps(); saveToStorage(); };
                container.appendChild(btn);
            });
        }

        function renderAlarmSettings() {
            const list = document.getElementById('alarm-list');
            list.innerHTML = '';
            [30, 20, 10, 5, 0].forEach(p => {
                const active = alarmConfig[p];
                const item = document.createElement('div');
                item.className = `flex items-center justify-between px-2 py-1 rounded-lg border text-[10px] ${active ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-transparent opacity-60'}`;
                item.onclick = () => { alarmConfig[p] = !alarmConfig[p]; renderAlarmSettings(); saveToStorage(); };
                item.innerHTML = `<span class="font-bold">${p === 0 ? 'å‡ºç™º' : p + 'åˆ†å‰'}</span><span>${active ? 'ğŸ””' : 'ğŸ”•'}</span>`;
                list.appendChild(item);
            });
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${completed} / ${total}`;
            
            if (total > 0 && completed === total && !isSettingsMode && !celebrationShownToday) {
                celebrationShownToday = true;
                handleCompletion();
            }
        }

        function handleCompletion() {
            const now = new Date();
            const todayIdx = now.getDay();
            
            // å‡ºç™ºæ™‚é–“å‰ã‹ãƒã‚§ãƒƒã‚¯
            const [depH, depM] = departureTime.split(':').map(Number);
            const limit = new Date(now); limit.setHours(depH, depM, 0, 0);
            
            let isPerfectWeek = false;

            // ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆï¼ˆæœ‰åŠ¹ãªæ›œæ—¥ã®å ´åˆï¼‰
            if (enabledDays[todayIdx] && now < limit) {
                if (!stamps[todayIdx]) {
                    stamps[todayIdx] = true;
                    // ä¸€é€±é–“ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯
                    const requiredCount = enabledDays.filter(d => d).length;
                    const earnedCount = stamps.filter((s, i) => s && enabledDays[i]).length;
                    if (requiredCount === earnedCount) {
                        isPerfectWeek = true;
                        perfectWeekCount++;
                        document.getElementById('perfect-count').textContent = perfectWeekCount;
                    }
                }
            }

            renderStamps();
            saveToStorage();
            showCelebration(isPerfectWeek);
        }

        function showCelebration(isPerfect) {
            const overlay = document.getElementById('celebration-overlay');
            const title = document.getElementById('main-celebration-title');
            const desc = document.getElementById('main-celebration-desc');
            const box = document.getElementById('celebration-title-box');
            
            if (isPerfect) {
                title.textContent = "ğŸ† ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼ ğŸ†";
                desc.textContent = "ã™ã”ã„ï¼ä¸€é€±é–“ã®ã˜ã‚…ã‚“ã³ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ãŸã‚ˆï¼";
                box.className = "bg-yellow-400 rounded-3xl p-10 shadow-2xl mb-6 text-white";
                speakText("ã™ã”ã„ï¼ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆé”æˆï¼ä¸€é€±é–“ã®æº–å‚™ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ãŸã‚ˆï¼");
            } else {
                title.textContent = "ã˜ã‚…ã‚“ã³ ã‹ã‚“ã‚Šã‚‡ã†ï¼";
                desc.textContent = "ã™ã”ã„ï¼ãœã‚“ã¶ ã§ããŸã­ï¼";
                box.className = "bg-white rounded-3xl p-10 shadow-2xl mb-6";
                speakText("æº–å‚™å®Œäº†ï¼ã™ã”ã„ã­ã€‚ã‚†ã£ãã‚Šéã”ã—ã¦ã­ã€‚");
            }

            // ç´™å¹é›ª
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = ['#f472b6', '#fb7185', '#fbbf24', '#60a5fa', '#a78bfa'][Math.floor(Math.random() * 5)];
                c.style.animationDelay = Math.random() * 3 + 's';
                c.style.width = '10px'; c.style.height = '10px';
                container.appendChild(c);
            }
            overlay.classList.remove('hidden');
        }

        function closeCelebration() { document.getElementById('celebration-overlay').classList.add('hidden'); }

        function toggleTask(id) {
            if (draggedItemIndex !== null) return;
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (!task.completed) celebrationShownToday = false;
                audioCtx.resume(); playBeep(task.completed ? 1100 : 440, 0.05);
                renderTasks(); saveToStorage();
            }
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (text) {
                tasks.push({ id: Date.now(), text, completed: false });
                celebrationShownToday = false;
                input.value = ''; renderTasks(); saveToStorage();
            }
        }

        function deleteTask(id) { tasks = tasks.filter(t => t.id !== id); renderTasks(); saveToStorage(); }
        function resetAll() { tasks = tasks.map(t => ({ ...t, completed: false })); renderTasks(); saveToStorage(); }
        function updateDepartureTime() { departureTime = document.getElementById('departure-input').value; saveToStorage(); }

        function toggleSettings() {
            isSettingsMode = !isSettingsMode;
            document.getElementById('normal-view').classList.toggle('hidden');
            document.getElementById('settings-view').classList.toggle('hidden');
            document.getElementById('settings-btn').classList.toggle('bg-blue-600');
            document.getElementById('settings-btn').querySelector('svg').classList.toggle('text-white');
            document.getElementById('countdown-card').classList.toggle('border-blue-400');
            renderTasks();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none'), 3000);
        }
    </script>
</body>
</html>
