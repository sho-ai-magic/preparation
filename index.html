<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥„Éû„Çπ„Çø„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden; /* ÂÖ®‰Ωì„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÁ¶ÅÊ≠¢ */
        }

        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none; /* „Éñ„É©„Ç¶„Ç∂„ÅÆ„Çπ„ÇØ„É≠„Éº„É´Á≠â„ÇíÂà∂Èôê„Åó„Å¶„Éâ„É©„ÉÉ„Ç∞„ÇíÂÑ™ÂÖà */
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            border-width: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Çπ„Çø„Ç§„É´ */
        .dragging {
            opacity: 0.5;
            scale: 0.95;
            z-index: 50;
        }

        /* Á¥ôÂêπÈõ™„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-out forwards;
        }

        /* „Ç¢„É©„Éº„É†„ÅÆ„Éë„É´„Çπ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pulse-orange {
            0%, 100% { background-color: #f97316; }
            50% { background-color: #ea580c; }
        }
        .animate-pulse-orange {
            animation: pulse-orange 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-blue-50 h-[100dvh] w-screen p-4 lg:p-6">

    <div class="flex flex-col lg:flex-row h-full gap-4 lg:gap-6">
        
        <!-- ÊôÇË®à„Éª„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Ç®„É™„Ç¢ -->
        <div class="w-full lg:w-1/3 flex flex-row lg:flex-col gap-3 lg:gap-6 shrink-0 order-1 lg:order-2">
            <!-- „Éá„Ç∏„Çø„É´ÊôÇË®à -->
            <div class="flex-1 lg:flex-none bg-gradient-to-br from-yellow-300 to-yellow-400 rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col items-center justify-center text-white border-b-4 lg:border-b-8 border-yellow-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2 opacity-80 hidden lg:block"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <div id="digital-clock" class="text-4xl lg:text-7xl font-black drop-shadow-lg tracking-tight leading-none">00:00</div>
                <div id="digital-seconds" class="text-lg lg:text-2xl font-bold opacity-90">00</div>
            </div>

            <!-- Âá∫Áô∫„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ / „Ç¢„É©„Éº„É†Ë®≠ÂÆöË°®Á§∫ -->
            <div id="countdown-card" class="flex-[1.5] lg:flex-1 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-6 flex flex-col items-center justify-center border-t-8 lg:border-t-[12px] border-orange-400 relative overflow-hidden min-w-0">
                
                <!-- ÈÄöÂ∏∏ÊôÇÔºö„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫ -->
                <div id="normal-view" class="w-full flex flex-col items-center">
                    <div class="text-orange-500 font-black text-xs lg:text-2xl mb-1 lg:mb-4 flex items-center gap-2">
                        <span>„Åó„ÇÖ„Å£„Å±„Å§„Åæ„Åß</span>
                    </div>
                    <!-- „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíË™øÊï¥„Åó„ÄÅ„ÅØ„ÅøÂá∫„Åó„ÇíÈò≤„Åê -->
                    <div id="countdown-timer" class="text-lg md:text-2xl lg:text-4xl font-black text-gray-700 text-center leading-tight mb-2 lg:mb-6 flex flex-wrap justify-center items-baseline gap-1">
                        „ÅÇ„Å® -- ÊôÇÈñì -- ÂàÜ -- Áßí
                    </div>
                    <div class="w-full border-t border-gray-100 pt-2 lg:pt-6">
                        <label class="block text-center text-[10px] lg:text-xs font-black text-gray-400 uppercase tracking-widest mb-1 lg:mb-2">„Åò„Åã„Çì</label>
                        <input type="time" id="departure-input" value="08:00" onchange="updateDepartureTime()" class="w-full max-w-[140px] lg:max-w-[200px] mx-auto block p-2 lg:p-4 bg-gray-50 border-2 border-gray-100 rounded-xl lg:rounded-2xl text-xl lg:text-4xl font-black text-center text-blue-600 focus:border-blue-400 focus:bg-white outline-none transition-all">
                    </div>
                </div>

                <!-- Ë®≠ÂÆö„É¢„Éº„ÉâÊôÇÔºö„Ç¢„É©„Éº„É†Ë®≠ÂÆö -->
                <div id="settings-view" class="w-full hidden h-full overflow-y-auto">
                    <h3 class="text-center font-black text-orange-500 mb-2 lg:mb-4 text-sm lg:text-base">üîî „Ç¢„É©„Éº„É†„Åõ„Å£„Å¶„ÅÑ</h3>
                    <div id="alarm-list" class="space-y-1 lg:space-y-2">
                        <!-- JS„ÅßÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- „Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç®„É™„Ç¢ -->
        <div class="flex-[2] min-h-0 w-full lg:w-2/3 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col order-2 lg:order-1 border-b-8 border-blue-200">
            <div class="flex justify-between items-center lg:items-end mb-3 lg:mb-6 shrink-0">
                <div>
                    <h1 class="text-xl lg:text-4xl font-black text-blue-600 lg:mb-2 leading-none">„ÅÇ„Åï„ÅÆ„Åò„ÇÖ„Çì„Å≥</h1>
                    <div class="flex items-center gap-2 lg:gap-4 mt-1">
                        <div class="w-24 lg:w-64 h-3 lg:h-6 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-50">
                            <div id="progress-bar" class="h-full bg-green-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="font-bold text-xs lg:text-xl text-gray-500">0 / 0</span>
                    </div>
                </div>
                <button onclick="toggleSettings()" id="settings-btn" class="p-2 lg:p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>

            <!-- „Çø„Çπ„ÇØ„Ç∞„É™„ÉÉ„Éâ -->
            <div id="task-grid" class="flex-1 min-h-0 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-2 lg:gap-6 pb-2 overflow-hidden">
                <!-- JavaScript„ÅßÁîüÊàê -->
            </div>

            <!-- ‰∏ãÈÉ®Êìç‰Ωú„Ç®„É™„Ç¢ -->
            <div class="mt-2 lg:mt-4 flex flex-col lg:flex-row justify-between items-center gap-2 shrink-0">
                <div id="add-task-form" class="flex gap-2 items-center w-full lg:w-auto">
                    <input type="text" id="new-task-input" placeholder="„ÅÇ„Åü„Çâ„Åó„ÅÑ„Çø„Çπ„ÇØ" class="flex-1 lg:w-48 px-3 py-1 lg:px-4 lg:py-2 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none font-bold text-xs lg:text-base">
                    <button onclick="addTask()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-xl transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <button onclick="resetAll()" class="flex items-center gap-2 text-gray-400 hover:text-gray-600 font-bold transition-colors text-[10px] lg:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    „ÅØ„Åò„ÇÅ„Åã„Çâ„ÇÑ„Çä„Å™„Åä„Åô
                </button>
            </div>
        </div>

    </div>

    <!-- „ÅäÁ•ù„ÅÑ„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="celebration-overlay" class="fixed inset-0 z-[100] bg-[#fff0f3]/95 hidden flex flex-col items-center justify-center text-rose-600 p-6 text-center overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div id="celebration-content" class="relative z-10 flex flex-col items-center">
            <div class="bg-white rounded-full p-6 mb-6 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#fb7185" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2"/><path d="M18 9h2a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-2"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            </div>
            <h2 class="text-4xl lg:text-6xl font-black mb-4">„Åò„ÇÖ„Çì„Å≥ „Åã„Çì„Çä„Çá„ÅÜÔºÅ</h2>
            <p class="text-xl lg:text-2xl font-bold opacity-90 mb-8">
                „Åô„Åî„ÅÑÔºÅ„Åú„Çì„Å∂ „Åß„Åç„Åü„Å≠ÔºÅ<br>
                „Åó„ÇÖ„Å£„Å±„Å§„ÅÆ„Åò„Åã„Çì„Åæ„Åß„ÄÅ<br>
                „ÇÜ„Å£„Åè„Çä „Åô„Åî„Åó„Å¶„Å≠„ÄÇ
            </p>
            <button onclick="closeCelebration()" class="bg-rose-500 text-white px-12 py-4 rounded-full text-2xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-transform">
                „ÅØ„Éº„ÅÑÔºÅ
            </button>
        </div>
    </div>

    <!-- „Ç¢„É©„Éº„É†„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="alarm-overlay" class="fixed inset-0 z-[110] animate-pulse-orange hidden flex flex-col items-center justify-center text-white p-10 text-center">
        <div class="bg-white/20 rounded-full p-10 mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        </div>
        <h2 id="alarm-title" class="text-3xl lg:text-6xl font-black mb-4">„ÅÇ„Å® 10„Åµ„ÇìÔºÅ</h2>
        <p id="alarm-desc" class="text-xl lg:text-2xl font-bold mb-12 opacity-90">„Åò„ÇÖ„Çì„Å≥„Çí „Åô„Åô„ÇÅ„Çà„ÅÜÔºÅ</p>
        <button onclick="closeAlarm()" class="bg-white text-orange-600 px-16 py-6 rounded-full text-3xl lg:text-4xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-transform">
            „Çè„Åã„Å£„ÅüÔºÅ
        </button>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full font-bold shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4 z-50">
        „É°„ÉÉ„Çª„Éº„Ç∏
    </div>

    <script>
        const DEFAULT_TASKS = [
            { id: 1, text: '„ÅØ„Åø„Åå„Åç', completed: false },
            { id: 2, text: '„ÅÇ„Åï„Åî„ÅØ„Çì', completed: false },
            { id: 3, text: '„Éà„Ç§„É¨', completed: false },
            { id: 4, text: '„Åç„Åå„Åà', completed: false },
            { id: 5, text: '„Åè„Å§„Åó„Åü', completed: false },
            { id: 6, text: '„É©„É≥„Éâ„Çª„É´', completed: false },
            { id: 7, text: '„Åã„Åø„ÅÆ„Åë', completed: false }
        ];

        let tasks = [];
        let departureTime = "08:00";
        let isSettingsMode = false;
        let lastDateString = new Date().toDateString(); 
        let alarmConfig = { 30: true, 20: true, 10: true, 5: true, 0: true };
        let lastAlarmTriggered = ""; 
        let draggedItemIndex = null;
        let celebrationShownToday = false; 

        window.onload = () => {
            loadFromStorage();
            renderTasks();
            renderAlarmSettings();
            startClock();
            
            document.getElementById('new-task-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            window.addEventListener('resize', renderTasks);
        };

        function saveToStorage() {
            const data = {
                tasks: tasks,
                departureTime: departureTime,
                saveDate: new Date().toDateString(),
                alarmConfig: alarmConfig,
                celebrationShownToday: celebrationShownToday
            };
            localStorage.setItem('morning_routine_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('morning_routine_data');
            const today = new Date().toDateString();

            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.saveDate !== today) {
                        tasks = (parsed.tasks || DEFAULT_TASKS).map(t => ({ ...t, completed: false }));
                        celebrationShownToday = false;
                    } else {
                        tasks = parsed.tasks || DEFAULT_TASKS;
                        celebrationShownToday = parsed.celebrationShownToday || false;
                    }
                    departureTime = parsed.departureTime || "08:00";
                    alarmConfig = parsed.alarmConfig || alarmConfig;
                    document.getElementById('departure-input').value = departureTime;
                } catch (e) {
                    tasks = DEFAULT_TASKS;
                }
            } else {
                tasks = DEFAULT_TASKS;
            }
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const nowDateString = now.toDateString();
                
                if (nowDateString !== lastDateString) {
                    lastDateString = nowDateString;
                    celebrationShownToday = false;
                    resetAll();
                }

                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('digital-clock').textContent = `${h}:${m}`;
                document.getElementById('digital-seconds').textContent = s;
                
                updateCountdown(now);
                checkAlarms(now);
            }, 1000);
        }

        function checkAlarms(now) {
            const [depH, depM] = departureTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(depH, depM, 0, 0);

            if (target < now) {
                target.setDate(target.getDate() + 1);
            }

            const diffMs = target - now;
            const diffMins = Math.floor(diffMs / 60000);
            const isAllDone = tasks.length > 0 && tasks.every(t => t.completed);

            [30, 20, 10, 5, 0].forEach(point => {
                if (diffMins === point && alarmConfig[point]) {
                    const triggerId = `${now.getHours()}:${now.getMinutes()}:${point}`;
                    if (lastAlarmTriggered === triggerId) return;
                    if ([30, 20, 10].includes(point) && isAllDone) return;

                    lastAlarmTriggered = triggerId;
                    showAlarm(point);
                }
            });
        }

        function showAlarm(point) {
            const overlay = document.getElementById('alarm-overlay');
            const title = document.getElementById('alarm-title');
            const desc = document.getElementById('alarm-desc');

            if (point === 0) {
                title.textContent = "„Åó„ÇÖ„Å£„Å±„Å§ÔºÅ";
                desc.textContent = "„Çè„Åô„Çå„ÇÇ„ÅÆ„ÅØ„Å™„ÅÑ„Åã„Å™Ôºü";
            } else {
                title.textContent = `„ÅÇ„Å® ${point}„Åµ„ÇìÔºÅ`;
                desc.textContent = "„Åò„ÇÖ„Çì„Å≥„Çí „Åô„Åô„ÇÅ„Çà„ÅÜÔºÅ";
            }
            overlay.classList.remove('hidden');
        }

        function closeAlarm() {
            document.getElementById('alarm-overlay').classList.add('hidden');
        }

        function updateCountdown(now) {
            const [depH, depM] = departureTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(depH, depM, 0, 0);

            if (target < now) {
                target.setDate(target.getDate() + 1);
            }

            let diff = target - now;
            const timerElement = document.getElementById('countdown-timer');
            
            if (diff <= 0) {
                timerElement.innerHTML = `<span class="text-red-500 animate-bounce block">„Åó„ÇÖ„Å£„Å±„Å§„ÅÆ<br>„Åò„Åã„Çì„Å†„ÇàÔºÅ</span>`;
            } else {
                const totalSecs = Math.floor(diff / 1000);
                const h = Math.floor(totalSecs / 3600);
                const m = Math.floor((totalSecs % 3600) / 60);
                const s = totalSecs % 60;

                let timeHtml = '<span class="text-xs lg:text-sm mr-1 opacity-60">„ÅÇ„Å®</span>';
                if (h > 0) {
                    timeHtml += `<span class="text-blue-600">${h}</span><span class="text-[0.6em] mx-0.5">ÊôÇÈñì</span>`;
                }
                timeHtml += `<span class="text-blue-600">${m}</span><span class="text-[0.6em] mx-0.5">ÂàÜ</span>`;
                timeHtml += `<span class="text-gray-400">${s}</span><span class="text-[0.6em] mx-0.5">Áßí</span>`;
                
                timerElement.innerHTML = timeHtml;
            }
        }

        // „Çø„ÉÉ„ÉÅ„Åß„ÅÆÂÖ•„ÇåÊõø„Åà„Çí„Çµ„Éù„Éº„Éà„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ
        function handleTouchStart(e, index) {
            draggedItemIndex = index;
            e.currentTarget.classList.add('dragging');
        }

        function handleTouchEnd(e) {
            const el = e.currentTarget;
            el.classList.remove('dragging');
            
            // Êåá„ÇíÈõ¢„Åó„Åü‰ΩçÁΩÆ„Å´„ÅÇ„ÇãË¶ÅÁ¥†„ÇíÁâπÂÆö
            const touch = e.changedTouches[0];
            const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetContainer = targetEl?.closest('.card-container');
            
            if (targetContainer) {
                const targetIndex = parseInt(targetContainer.getAttribute('data-index'));
                if (draggedItemIndex !== null && draggedItemIndex !== targetIndex) {
                    const movedItem = tasks.splice(draggedItemIndex, 1)[0];
                    tasks.splice(targetIndex, 0, movedItem);
                    saveToStorage();
                    renderTasks();
                }
            }
            draggedItemIndex = null;
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid');
            grid.innerHTML = '';
            const cols = window.innerWidth >= 640 ? 3 : 2;
            const rows = Math.ceil(tasks.length / cols);
            grid.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;

            tasks.forEach((task, index) => {
                const card = document.createElement('div');
                card.className = 'card-container';
                card.setAttribute('draggable', 'true');
                card.setAttribute('data-index', index);
                
                // „Éû„Ç¶„ÇπÊìç‰ΩúÁî®„ÅÆ„Ç§„Éô„É≥„Éà
                card.ondragstart = (e) => {
                    draggedItemIndex = index;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => card.classList.add('dragging'), 0);
                };
                card.ondragover = (e) => e.preventDefault();
                card.ondrop = (e) => {
                    e.preventDefault();
                    if (draggedItemIndex === null || draggedItemIndex === index) return;
                    const movedItem = tasks.splice(draggedItemIndex, 1)[0];
                    tasks.splice(index, 0, movedItem);
                    saveToStorage();
                    renderTasks();
                };
                card.ondragend = () => {
                    card.classList.remove('dragging');
                    draggedItemIndex = null;
                };

                // „Çø„ÉÉ„ÉÅÊìç‰ΩúÁî®„ÅÆ„Ç§„Éô„É≥„Éà („Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú)
                card.addEventListener('touchstart', (e) => handleTouchStart(e, index), {passive: true});
                card.addEventListener('touchend', handleTouchEnd);

                card.innerHTML = `
                    <div class="card-inner ${task.completed ? 'is-flipped' : ''}" onclick="toggleTask(${task.id})">
                        <div class="card-front bg-white border-blue-200 hover:border-blue-400 text-blue-700">
                            <span class="text-sm lg:text-xl xl:text-2xl font-black px-1 text-center pointer-events-none">${task.text}</span>
                            ${isSettingsMode ? `
                                <button onclick="event.stopPropagation(); deleteTask(${task.id})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600 z-10 pointer-events-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            ` : ''}
                        </div>
                        <div class="card-back bg-green-100 border-green-400 text-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="mb-1 text-green-500 pointer-events-none lg:w-8 lg:h-8"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span class="text-[10px] lg:text-lg font-black pointer-events-none">„Åß„Åç„ÅüÔºÅ</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            updateProgress();
        }

        function renderAlarmSettings() {
            const list = document.getElementById('alarm-list');
            list.innerHTML = '';
            [30, 20, 10, 5, 0].forEach(p => {
                const active = alarmConfig[p];
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-1 lg:p-2 rounded-xl border-2 transition-all cursor-pointer ${active ? 'bg-orange-50 border-orange-300' : 'bg-gray-50 border-transparent opacity-60'}`;
                item.onclick = () => toggleAlarm(p);
                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-black text-xs lg:text-sm ${active ? 'text-orange-600' : 'text-gray-400'}">${p === 0 ? '„Åó„ÇÖ„Å£„Å±„Å§ÔºÅ' : p + '„Åµ„Çì„Åæ„Åà'}</span>
                        ${[30, 20, 10].includes(p) ? '<span class="text-[6px] lg:text-[8px] text-gray-400 font-bold leading-none">‚Äª„Åæ„Å†„ÅÆ„Å®„Åç</span>' : ''}
                    </div>
                    <div class="text-sm lg:text-xl">${active ? 'üîî' : 'üîï'}</div>
                `;
                list.appendChild(item);
            });
        }

        function toggleAlarm(point) {
            alarmConfig[point] = !alarmConfig[point];
            renderAlarmSettings();
            saveToStorage();
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${completed} / ${total}`;

            if (total > 0 && completed === total && !isSettingsMode && !celebrationShownToday) {
                celebrationShownToday = true;
                saveToStorage();
                setTimeout(showCelebration, 600);
            }
        }

        function showCelebration() {
            const overlay = document.getElementById('celebration-overlay');
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            const colors = ['#f97316', '#fbbf24', '#4ade80', '#60a5fa', '#f472b6'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = confetti.style.width;
                container.appendChild(confetti);
            }
            overlay.classList.remove('hidden');
        }

        function closeCelebration() {
            document.getElementById('celebration-overlay').classList.add('hidden');
        }

        function toggleTask(id) {
            // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (draggedItemIndex !== null) return;
            
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (!task.completed) celebrationShownToday = false;
                renderTasks();
                saveToStorage();
            }
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (text) {
                tasks.push({ id: Date.now(), text, completed: false });
                celebrationShownToday = false;
                input.value = '';
                renderTasks();
                saveToStorage();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            saveToStorage();
        }

        function resetAll() {
            tasks = tasks.map(t => ({ ...t, completed: false }));
            renderTasks();
            saveToStorage();
        }

        function updateDepartureTime() {
            departureTime = document.getElementById('departure-input').value;
            saveToStorage();
            showToast(`„Åó„ÇÖ„Å£„Å±„Å§„ÅØ ${departureTime}`);
        }

        function toggleSettings() {
            isSettingsMode = !isSettingsMode;
            const normalView = document.getElementById('normal-view');
            const settingsView = document.getElementById('settings-view');
            const btn = document.getElementById('settings-btn');
            const card = document.getElementById('countdown-card');

            if (isSettingsMode) {
                normalView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                btn.classList.replace('bg-gray-100', 'bg-blue-600');
                btn.querySelector('svg').classList.replace('text-gray-500', 'text-white');
                card.classList.replace('border-orange-400', 'border-blue-400');
            } else {
                normalView.classList.remove('hidden');
                settingsView.classList.add('hidden');
                btn.classList.replace('bg-blue-600', 'bg-gray-100');
                btn.querySelector('svg').classList.replace('text-white', 'text-gray-500');
                card.classList.replace('border-blue-400', 'border-orange-400');
            }
            renderTasks();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
            }, 2000);
        }
    </script>
</body>
</html>
