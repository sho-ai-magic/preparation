<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ã•ã®ã˜ã‚…ã‚“ã³ãƒã‚¹ã‚¿ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden; /* å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
        }

        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none; /* ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®å¹²æ¸‰ã‚’é˜²ã */
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem;
            border-width: 4px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .dragging {
            opacity: 0.4;
            scale: 0.95;
        }

        /* ç´™å¹é›ªã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-out forwards;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒ ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse-orange {
            0%, 100% { background-color: #f97316; }
            50% { background-color: #ea580c; }
        }
        .animate-pulse-orange {
            animation: pulse-orange 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-blue-50 h-[100dvh] w-screen p-4 lg:p-6">

    <div class="flex flex-col lg:flex-row h-full gap-4 lg:gap-6">
        
        <!-- æ™‚è¨ˆãƒ»ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="w-full lg:w-1/3 flex flex-row lg:flex-col gap-4 lg:gap-6 shrink-0 order-1 lg:order-2">
            <!-- ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚è¨ˆ -->
            <div class="flex-1 lg:flex-none bg-gradient-to-br from-yellow-300 to-yellow-400 rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col items-center justify-center text-white border-b-4 lg:border-b-8 border-yellow-500/30">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mb-2 opacity-80 hidden lg:block"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <div id="digital-clock" class="text-4xl lg:text-7xl font-black drop-shadow-lg tracking-tight leading-none">00:00</div>
                <div id="digital-seconds" class="text-lg lg:text-2xl font-bold opacity-90">00</div>
            </div>

            <!-- å‡ºç™ºã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ / ã‚¢ãƒ©ãƒ¼ãƒ è¨­å®šè¡¨ç¤º -->
            <div id="countdown-card" class="flex-1 lg:flex-1 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-6 flex flex-col items-center justify-center border-t-8 lg:border-t-[12px] border-orange-400 relative overflow-hidden">
                
                <!-- é€šå¸¸æ™‚ï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º -->
                <div id="normal-view" class="w-full flex flex-col items-center">
                    <div class="text-orange-500 font-black text-sm lg:text-2xl mb-2 lg:mb-4 flex items-center gap-2">
                        <span>ã—ã‚…ã£ã±ã¤ã¾ã§</span>
                    </div>
                    <div id="countdown-timer" class="text-xl lg:text-4xl font-black text-gray-700 text-center leading-tight mb-2 lg:mb-6 whitespace-nowrap">
                        ã‚ã¨ -- æ™‚é–“ -- åˆ† -- ç§’
                    </div>
                    <div class="w-full border-t border-gray-100 pt-2 lg:pt-6">
                        <label class="block text-center text-[10px] lg:text-xs font-black text-gray-400 uppercase tracking-widest mb-1 lg:mb-2">ã˜ã‹ã‚“</label>
                        <input type="time" id="departure-input" value="08:00" onchange="updateDepartureTime()" class="w-full max-w-[160px] lg:max-w-[200px] mx-auto block p-2 lg:p-4 bg-gray-50 border-2 border-gray-100 rounded-xl lg:rounded-2xl text-xl lg:text-4xl font-black text-center text-blue-600 focus:border-blue-400 focus:bg-white outline-none transition-all">
                    </div>
                </div>

                <!-- è¨­å®šãƒ¢ãƒ¼ãƒ‰æ™‚ï¼šã‚¢ãƒ©ãƒ¼ãƒ è¨­å®š -->
                <div id="settings-view" class="w-full hidden h-full overflow-y-auto">
                    <h3 class="text-center font-black text-orange-500 mb-4">ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒ ã›ã£ã¦ã„</h3>
                    <div id="alarm-list" class="space-y-2">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¨ãƒªã‚¢ -->
        <div class="flex-1 min-h-0 w-full lg:w-2/3 bg-white rounded-[1.5rem] lg:rounded-[2rem] shadow-xl p-4 lg:p-8 flex flex-col order-2 lg:order-1 border-b-8 border-blue-200">
            <div class="flex justify-between items-center lg:items-end mb-4 lg:mb-6 shrink-0">
                <div>
                    <h1 class="text-2xl lg:text-4xl font-black text-blue-600 lg:mb-2">ã‚ã•ã®ã˜ã‚…ã‚“ã³</h1>
                    <div class="flex items-center gap-2 lg:gap-4">
                        <div class="w-32 lg:w-64 h-4 lg:h-6 bg-gray-100 rounded-full overflow-hidden border-2 border-gray-50">
                            <div id="progress-bar" class="h-full bg-green-400 transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                        <span id="progress-text" class="font-bold text-sm lg:text-xl text-gray-500">0 / 0</span>
                    </div>
                </div>
                <button onclick="toggleSettings()" id="settings-btn" class="p-2 lg:p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>

            <!-- ã‚¿ã‚¹ã‚¯ã‚°ãƒªãƒƒãƒ‰ -->
            <div id="task-grid" class="flex-1 min-h-0 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3 lg:gap-6 pb-2 overflow-hidden">
                <!-- JavaScriptã§ç”Ÿæˆ -->
            </div>

            <!-- ä¸‹éƒ¨æ“ä½œã‚¨ãƒªã‚¢ -->
            <div class="mt-4 flex flex-col lg:flex-row justify-between items-center gap-2 shrink-0">
                <div id="add-task-form" class="flex gap-2 items-center w-full lg:w-auto">
                    <input type="text" id="new-task-input" placeholder="ã‚ãŸã‚‰ã—ã„ã‚¿ã‚¹ã‚¯" class="flex-1 lg:w-48 px-4 py-2 border-2 border-gray-200 rounded-xl focus:border-blue-400 outline-none font-bold text-sm lg:text-base">
                    <button onclick="addTask()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-xl transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <button onclick="resetAll()" class="flex items-center gap-2 text-gray-400 hover:text-gray-600 font-bold transition-colors text-xs lg:text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    ã¯ã˜ã‚ã‹ã‚‰ã‚„ã‚ŠãªãŠã™
                </button>
            </div>
        </div>

    </div>

    <!-- ãŠç¥ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="celebration-overlay" class="fixed inset-0 z-[100] bg-[#fff0f3]/95 hidden flex flex-col items-center justify-center text-rose-600 p-6 text-center overflow-hidden">
        <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
        <div id="celebration-content" class="relative z-10 flex flex-col items-center">
            <div class="bg-white rounded-full p-6 mb-6 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#fb7185" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2"/><path d="M18 9h2a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-2"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            </div>
            <h2 class="text-4xl lg:text-6xl font-black mb-4">ã˜ã‚…ã‚“ã³ ã‹ã‚“ã‚Šã‚‡ã†ï¼</h2>
            <p class="text-xl lg:text-2xl font-bold opacity-90 mb-8">
                ã™ã”ã„ï¼ãœã‚“ã¶ ã§ããŸã­ï¼<br>
                ã—ã‚…ã£ã±ã¤ã®ã˜ã‹ã‚“ã¾ã§ã€<br>
                ã‚†ã£ãã‚Š ã™ã”ã—ã¦ã­ã€‚
            </p>
            <button onclick="closeCelebration()" class="bg-rose-500 text-white px-12 py-4 rounded-full text-2xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-transform">
                ã¯ãƒ¼ã„ï¼
            </button>
        </div>
    </div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="alarm-overlay" class="fixed inset-0 z-[110] animate-pulse-orange hidden flex flex-col items-center justify-center text-white p-10 text-center">
        <div class="bg-white/20 rounded-full p-10 mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        </div>
        <h2 id="alarm-title" class="text-6xl font-black mb-4">ã‚ã¨ 10ãµã‚“ï¼</h2>
        <p id="alarm-desc" class="text-2xl font-bold mb-12 opacity-90">ã˜ã‚…ã‚“ã³ã‚’ ã™ã™ã‚ã‚ˆã†ï¼</p>
        <button onclick="closeAlarm()" class="bg-white text-orange-600 px-16 py-6 rounded-full text-4xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-transform">
            ã‚ã‹ã£ãŸï¼
        </button>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full font-bold shadow-2xl transition-all opacity-0 pointer-events-none transform translate-y-4 z-50">
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    </div>

    <script>
        const DEFAULT_TASKS = [
            { id: 1, text: 'ã¯ã¿ãŒã', completed: false },
            { id: 2, text: 'ã‚ã•ã”ã¯ã‚“', completed: false },
            { id: 3, text: 'ãƒˆã‚¤ãƒ¬', completed: false },
            { id: 4, text: 'ããŒãˆ', completed: false },
            { id: 5, text: 'ãã¤ã—ãŸ', completed: false },
            { id: 6, text: 'ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«', completed: false },
            { id: 7, text: 'ã‹ã¿ã®ã‘', completed: false }
        ];

        let tasks = [];
        let departureTime = "08:00";
        let isSettingsMode = false;
        let lastDateString = new Date().toDateString(); 
        let alarmConfig = { 30: true, 20: true, 10: true, 5: true, 0: true };
        let lastAlarmTriggered = ""; 
        let draggedItemIndex = null;
        let celebrationShownToday = false; // é‡è¤‡è¡¨ç¤ºé˜²æ­¢ç”¨

        window.onload = () => {
            loadFromStorage();
            renderTasks();
            renderAlarmSettings();
            startClock();
            
            document.getElementById('new-task-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            window.addEventListener('resize', renderTasks);
        };

        function saveToStorage() {
            const data = {
                tasks: tasks,
                departureTime: departureTime,
                saveDate: new Date().toDateString(),
                alarmConfig: alarmConfig,
                celebrationShownToday: celebrationShownToday
            };
            localStorage.setItem('morning_routine_data', JSON.stringify(data));
        }

        function loadFromStorage() {
            const savedData = localStorage.getItem('morning_routine_data');
            const today = new Date().toDateString();

            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    if (parsed.saveDate !== today) {
                        tasks = (parsed.tasks || DEFAULT_TASKS).map(t => ({ ...t, completed: false }));
                        celebrationShownToday = false;
                    } else {
                        tasks = parsed.tasks || DEFAULT_TASKS;
                        celebrationShownToday = parsed.celebrationShownToday || false;
                    }
                    departureTime = parsed.departureTime || "08:00";
                    alarmConfig = parsed.alarmConfig || alarmConfig;
                    document.getElementById('departure-input').value = departureTime;
                } catch (e) {
                    tasks = DEFAULT_TASKS;
                }
            } else {
                tasks = DEFAULT_TASKS;
            }
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const nowDateString = now.toDateString();
                
                if (nowDateString !== lastDateString) {
                    lastDateString = nowDateString;
                    celebrationShownToday = false; // æ–°ã—ã„æ—¥ã«ãƒªã‚»ãƒƒãƒˆ
                    resetAll();
                    showToast("ã‚ãŸã‚‰ã—ã«æ—¥ã«ãªã£ãŸã‚ˆï¼ãƒªã‚»ãƒƒãƒˆã—ãŸã‚ˆã€‚");
                }

                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                document.getElementById('digital-clock').textContent = `${h}:${m}`;
                document.getElementById('digital-seconds').textContent = s;
                
                updateCountdown(now);
                checkAlarms(now);
            }, 1000);
        }

        function checkAlarms(now) {
            const [depH, depM] = departureTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(depH, depM, 0, 0);

            // ã™ã§ã«å‡ºç™ºæ™‚é–“ã‚’éãã¦ã„ã‚‹å ´åˆã¯ç¿Œæ—¥ã®åŒæ™‚åˆ»ã¨ã—ã¦è¨ˆç®—
            if (target < now) {
                target.setDate(target.getDate() + 1);
            }

            const diffMs = target - now;
            const diffMins = Math.floor(diffMs / 60000);
            const isAllDone = tasks.length > 0 && tasks.every(t => t.completed);

            [30, 20, 10, 5, 0].forEach(point => {
                if (diffMins === point && alarmConfig[point]) {
                    const triggerId = `${now.getHours()}:${now.getMinutes()}:${point}`;
                    if (lastAlarmTriggered === triggerId) return;
                    if ([30, 20, 10].includes(point) && isAllDone) return;

                    lastAlarmTriggered = triggerId;
                    showAlarm(point);
                }
            });
        }

        function showAlarm(point) {
            const overlay = document.getElementById('alarm-overlay');
            const title = document.getElementById('alarm-title');
            const desc = document.getElementById('alarm-desc');

            if (point === 0) {
                title.textContent = "ã—ã‚…ã£ã±ã¤ã® ã˜ã‹ã‚“ï¼";
                desc.textContent = "ã‚ã™ã‚Œã‚‚ã®ã¯ãªã„ã‹ãªï¼Ÿ";
            } else {
                title.textContent = `ã‚ã¨ ${point}ãµã‚“ï¼`;
                desc.textContent = "ã˜ã‚…ã‚“ã³ã‚’ ã™ã™ã‚ã‚ˆã†ï¼";
            }
            overlay.classList.remove('hidden');
        }

        function closeAlarm() {
            document.getElementById('alarm-overlay').classList.add('hidden');
        }

        function updateCountdown(now) {
            const [depH, depM] = departureTime.split(':').map(Number);
            const target = new Date(now);
            target.setHours(depH, depM, 0, 0);

            // æ—¥ä»˜ã‚’ã¾ãŸãå ´åˆï¼ˆä¾‹ï¼šç¾åœ¨23æ™‚ã€å‡ºç™º8æ™‚ï¼‰ã®èª¿æ•´
            if (target < now) {
                target.setDate(target.getDate() + 1);
            }

            let diff = target - now;
            const timerElement = document.getElementById('countdown-timer');
            
            // å‡ºç™ºã¾ã§1åˆ†æœªæº€ã§ç¾åœ¨æ™‚åˆ»ã¨ã»ã¼åŒã˜å ´åˆï¼ˆãƒãƒ¼ã‚¸ãƒ³ï¼‰
            if (diff <= 0) {
                timerElement.innerHTML = `<span class="text-red-500 animate-bounce block">ã—ã‚…ã£ã±ã¤ã®<br>ã˜ã‹ã‚“ã ã‚ˆï¼</span>`;
            } else {
                const totalSecs = Math.floor(diff / 1000);
                const h = Math.floor(totalSecs / 3600);
                const m = Math.floor((totalSecs % 3600) / 60);
                const s = totalSecs % 60;

                let timeHtml = 'ã‚ã¨ ';
                if (h > 0) {
                    timeHtml += `<span class="text-blue-600 text-2xl lg:text-4xl">${h}</span> æ™‚é–“ `;
                }
                timeHtml += `<span class="text-blue-600 text-2xl lg:text-4xl">${m}</span> åˆ† <span class="text-lg lg:text-2xl">${s} ç§’</span>`;
                
                timerElement.innerHTML = timeHtml;
            }
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid');
            grid.innerHTML = '';
            const cols = window.innerWidth >= 640 ? 3 : 2;
            const rows = Math.ceil(tasks.length / cols);
            grid.style.gridTemplateRows = `repeat(${rows}, minmax(0, 1fr))`;

            tasks.forEach((task, index) => {
                const card = document.createElement('div');
                card.className = 'card-container';
                card.setAttribute('draggable', 'true');
                
                card.ondragstart = (e) => {
                    draggedItemIndex = index;
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => card.classList.add('dragging'), 0);
                };

                card.ondragover = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                };

                card.ondrop = (e) => {
                    e.preventDefault();
                    if (draggedItemIndex === null || draggedItemIndex === index) return;
                    const movedItem = tasks.splice(draggedItemIndex, 1)[0];
                    tasks.splice(index, 0, movedItem);
                    saveToStorage();
                    renderTasks();
                };

                card.ondragend = () => {
                    card.classList.remove('dragging');
                    draggedItemIndex = null;
                };

                card.innerHTML = `
                    <div class="card-inner ${task.completed ? 'is-flipped' : ''}" onclick="toggleTask(${task.id})">
                        <div class="card-front bg-white border-blue-200 hover:border-blue-400 text-blue-700">
                            <span class="text-base lg:text-xl xl:text-2xl font-black px-2 text-center pointer-events-none">${task.text}</span>
                            ${isSettingsMode ? `
                                <button onclick="event.stopPropagation(); deleteTask(${task.id})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg hover:bg-red-600 z-10 pointer-events-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            ` : ''}
                        </div>
                        <div class="card-back bg-green-100 border-green-400 text-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="mb-1 text-green-500 pointer-events-none"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span class="text-xs lg:text-lg font-black pointer-events-none">ã§ããŸï¼</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
            updateProgress();
        }

        function renderAlarmSettings() {
            const list = document.getElementById('alarm-list');
            list.innerHTML = '';
            [30, 20, 10, 5, 0].forEach(p => {
                const active = alarmConfig[p];
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-2 rounded-xl border-2 transition-all cursor-pointer ${active ? 'bg-orange-50 border-orange-300' : 'bg-gray-50 border-transparent opacity-60'}`;
                item.onclick = () => toggleAlarm(p);
                item.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-black ${active ? 'text-orange-600' : 'text-gray-400'}">${p === 0 ? 'ã—ã‚…ã£ã±ã¤ï¼' : p + 'ãµã‚“ã¾ãˆ'}</span>
                        ${[30, 20, 10].includes(p) ? '<span class="text-[8px] text-gray-400 font-bold leading-none">â€»ã¾ã ã®ã¨ãã ã‘</span>' : ''}
                    </div>
                    <div class="text-xl">${active ? 'ğŸ””' : 'ğŸ”•'}</div>
                `;
                list.appendChild(item);
            });
        }

        function toggleAlarm(point) {
            alarmConfig[point] = !alarmConfig[point];
            renderAlarmSettings();
            saveToStorage();
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length;
            const percent = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-text').textContent = `${completed} / ${total}`;

            // å…¨å®Œäº†ãƒã‚§ãƒƒã‚¯ (ã¾ã ä»Šæ—¥ä¸€åº¦ã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¡¨ç¤º)
            if (total > 0 && completed === total && !isSettingsMode && !celebrationShownToday) {
                celebrationShownToday = true;
                saveToStorage();
                setTimeout(showCelebration, 600);
            }
        }

        function showCelebration() {
            const overlay = document.getElementById('celebration-overlay');
            const container = document.getElementById('confetti-container');
            container.innerHTML = '';
            
            const colors = ['#f97316', '#fbbf24', '#4ade80', '#60a5fa', '#f472b6'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = confetti.style.width;
                container.appendChild(confetti);
            }
            overlay.classList.remove('hidden');
        }

        function closeCelebration() {
            document.getElementById('celebration-overlay').classList.add('hidden');
            // resetAll() ã¯å‘¼ã³å‡ºã•ãªã„ (ã€Œã§ããŸï¼ã€ã®çŠ¶æ…‹ã‚’ç¶­æŒ)
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                // å…¨å®Œäº†ã‹ã‚‰ä¸€ã¤æˆ»ã—ãŸå ´åˆã¯ã€å†åº¦ãŠç¥ã„ãŒå‡ºã‚‹ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ã‚’æˆ»ã™
                if (!task.completed) celebrationShownToday = false;
                renderTasks();
                saveToStorage();
            }
        }

        function addTask() {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (text) {
                tasks.push({ id: Date.now(), text, completed: false });
                celebrationShownToday = false;
                input.value = '';
                renderTasks();
                saveToStorage();
                showToast("ã¤ã„ã‹ã—ãŸã‚ˆï¼");
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            saveToStorage();
            showToast("ã‘ã—ãŸã‚ˆã€‚");
        }

        function resetAll() {
            tasks = tasks.map(t => ({ ...t, completed: false }));
            renderTasks();
            saveToStorage();
        }

        function updateDepartureTime() {
            departureTime = document.getElementById('departure-input').value;
            saveToStorage();
            showToast(`ã—ã‚…ã£ã±ã¤ã¯ ${departureTime}`);
        }

        function toggleSettings() {
            isSettingsMode = !isSettingsMode;
            const normalView = document.getElementById('normal-view');
            const settingsView = document.getElementById('settings-view');
            const btn = document.getElementById('settings-btn');
            const card = document.getElementById('countdown-card');

            if (isSettingsMode) {
                normalView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                btn.classList.replace('bg-gray-100', 'bg-blue-600');
                btn.querySelector('svg').classList.replace('text-gray-500', 'text-white');
                card.classList.replace('border-orange-400', 'border-blue-400');
            } else {
                normalView.classList.remove('hidden');
                settingsView.classList.add('hidden');
                btn.classList.replace('bg-blue-600', 'bg-gray-100');
                btn.querySelector('svg').classList.replace('text-white', 'text-gray-500');
                card.classList.replace('border-blue-400', 'border-orange-400');
            }
            renderTasks();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
            }, 2000);
        }
    </script>
</body>
</html>
